! Leaf-1 Configuration
! VxLAN EVPN Spine-Leaf Topology
! Role: VTEP with VxLAN/EVPN

hostname Leaf-1

! Enable required features
nv overlay evpn
feature bgp
feature fabric forwarding
feature interface-vlan
feature vn-segment-vlan-based
feature nv overlay

! Configure VRF for management
vrf context management
  ip route 0.0.0.0/0 192.168.1.254

! Configure tenant VRFs
vrf context Tenant-A
  vni 50001
  rd auto
  address-family ipv4 unicast
    route-target both auto
    route-target both auto evpn

vrf context Tenant-B
  vni 50002
  rd auto
  address-family ipv4 unicast
    route-target both auto
    route-target both auto evpn

! VLAN Configuration
vlan 10
  name Tenant-A-Web
  vn-segment 10010

vlan 20
  name Tenant-A-App
  vn-segment 10020

vlan 30
  name Tenant-B-Web
  vn-segment 10030

vlan 999
  name L3VNI-Tenant-A
  vn-segment 50001

vlan 998
  name L3VNI-Tenant-B
  vn-segment 50002

! Fabric Anycast Gateway MAC
fabric forwarding anycast-gateway-mac 0000.2222.3333

! Loopback Interfaces
interface loopback0
  description BGP Router-ID
  ip address 10.0.0.11/32

interface loopback1
  description VTEP Source Interface
  ip address 10.0.0.111/32

! Point-to-Point Links to Spine Switches
interface Ethernet1/1
  description Link to Spine-1
  no switchport
  mtu 9216
  ip address 10.1.1.1/31
  no shutdown

interface Ethernet1/2
  description Link to Spine-2
  no switchport
  mtu 9216
  ip address 10.1.2.1/31
  no shutdown

! Management Interface
interface mgmt0
  vrf member management
  ip address 192.168.1.11/24

! SVI Configuration - Tenant-A
interface Vlan10
  description Tenant-A Web Tier
  no shutdown
  vrf member Tenant-A
  ip address 10.10.10.1/24
  fabric forwarding mode anycast-gateway

interface Vlan20
  description Tenant-A App Tier
  no shutdown
  vrf member Tenant-A
  ip address 10.10.20.1/24
  fabric forwarding mode anycast-gateway

! SVI Configuration - Tenant-B
interface Vlan30
  description Tenant-B Web Tier
  no shutdown
  vrf member Tenant-B
  ip address 10.20.30.1/24
  fabric forwarding mode anycast-gateway

! L3 VNI SVI Configuration
interface Vlan999
  description L3VNI SVI for Tenant-A
  no shutdown
  vrf member Tenant-A
  ip forward

interface Vlan998
  description L3VNI SVI for Tenant-B
  no shutdown
  vrf member Tenant-B
  ip forward

! NVE Interface Configuration
interface nve1
  no shutdown
  host-reachability protocol bgp
  source-interface loopback1
  member vni 10010
    ingress-replication protocol bgp
  member vni 10020
    ingress-replication protocol bgp
  member vni 10030
    ingress-replication protocol bgp
  member vni 50001 associate-vrf
  member vni 50002 associate-vrf

! EVPN Configuration
evpn
  vni 10010 l2
    rd auto
    route-target import auto
    route-target export auto
  vni 10020 l2
    rd auto
    route-target import auto
    route-target export auto
  vni 10030 l2
    rd auto
    route-target import auto
    route-target export auto

! BGP Configuration
router bgp 65001
  router-id 10.0.0.11
  log-neighbor-changes
  address-family ipv4 unicast
    network 10.0.0.11/32
    network 10.0.0.111/32
  address-family l2vpn evpn
  
  ! BGP Peering with Spine-1 (Overlay)
  neighbor 10.0.0.1
    remote-as 65000
    description Spine-1
    update-source loopback0
    ebgp-multihop 2
    address-family l2vpn evpn
      send-community
      send-community extended
  
  ! BGP Peering with Spine-2 (Overlay)
  neighbor 10.0.0.2
    remote-as 65000
    description Spine-2
    update-source loopback0
    ebgp-multihop 2
    address-family l2vpn evpn
      send-community
      send-community extended
  
  ! Underlay BGP - Spine-1
  neighbor 10.1.1.0
    remote-as 65000
    description Spine-1-Underlay
    address-family ipv4 unicast
  
  ! Underlay BGP - Spine-2
  neighbor 10.1.2.0
    remote-as 65000
    description Spine-2-Underlay
    address-family ipv4 unicast
  
  ! Tenant-A VRF BGP
  vrf Tenant-A
    address-family ipv4 unicast
      advertise l2vpn evpn
  
  ! Tenant-B VRF BGP
  vrf Tenant-B
    address-family ipv4 unicast
      advertise l2vpn evpn

! End of Configuration
